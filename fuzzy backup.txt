# fuzzy.py
import time
import threading
from datetime import datetime
from relay_control import RelayControl
from database import simpan_relay_mysql
from supabase_client import simpan_relay_supabase


relay_ctrl = RelayControl()

def siram_air(durasi):
    def worker():
        if relay_ctrl.start_relay():
            print(f"Relay ON selama {durasi} detik")
            time.sleep(durasi)
            relay_ctrl.stop_relay()
            print("Relay OFF setelah durasi")
        else:
            print("Relay sudah ON, tidak menyalakan ulang")
    threading.Thread(target=worker, daemon=True).start()

def label_ph(ph):
    if ph < 4.4:
        return "Sangat Masam"
    elif 4.4 <= ph <= 5.6:
        return "Masam"
    elif 5.6 < ph <= 6.5:
        return "Sedikit Masam"
    elif 6.5 < ph <= 7.5:
        return "Netral"
    elif ph > 7.5:
        return "Basa"
    else:
        return "Tidak Terdefinisi"

def label_kelembaban(nilai_adc):
    if nilai_adc > 800:
        return "Kering"
    elif nilai_adc > 400:
        return "Lembab"
    else:
        return "Basah"

def fuzzy_rules(ph_label, kelembaban_label):
    rules = {
        ("Sangat Masam", "Kering"): 900,
        ("Masam", "Kering"): 900,
        ("Sedikit Masam", "Kering"): 900,
        ("Netral", "Kering"): 900,
        ("Basa", "Kering"): 900,

        ("Sangat Masam", "Lembab"): 900,
        ("Masam", "Lembab"): 900,
        ("Sedikit Masam", "Lembab"): 900,
        ("Netral", "Lembab"): 900,
        ("Basa", "Lembab"): 900,

        ("Sangat Masam", "Basah"): 0,
        ("Masam", "Basah"): 0,
        ("Sedikit Masam", "Basah"): 0,
        ("Netral", "Basah"): 0,
        ("Basa", "Basah"): 0
    }
    return rules.get((ph_label, kelembaban_label), 0)


def waktu_sesuai_jadwal():
    now = datetime.now()
    return now.minute == 0

def evaluasi_fuzzy(ph, kelembaban_adc):
    ph_status = label_ph(ph)
    kelembaban_status = label_kelembaban(kelembaban_adc)
    kelembaban_persen = max(0, min(100, round((1023 - kelembaban_adc) / 1023 * 100, 2)))

    durasi = fuzzy_rules(ph_status, kelembaban_status)

    print(f"[FUZZY] pH: {ph} -> {ph_status}, Kelembaban ADC: {kelembaban_adc} -> {kelembaban_status} ({kelembaban_persen}%)")
    print(f"[FUZZY] Durasi yang diusulkan: {durasi} detik")

    if waktu_sesuai_jadwal():
        if durasi > 0:
            print(f"[FUZZY] Menyiram selama {durasi} detik...")
            siram_air(durasi)
            simpan_relay_mysql(ph, ph_status, kelembaban_adc, kelembaban_persen, kelembaban_status, durasi, "SIRAM", 1)
            simpan_relay_supabase(ph, ph_status, kelembaban_adc, kelembaban_persen, kelembaban_status, durasi, "SIRAM", 1)
        else:
            print("[FUZZY] Jadwal penyiraman, tapi aturan fuzzy menyatakan TIDAK SIRAM.")
            simpan_relay_mysql(ph, ph_status, kelembaban_adc, kelembaban_persen, kelembaban_status, 0, "TIDAK SIRAM", 0)
            simpan_relay_supabase(ph, ph_status, kelembaban_adc, kelembaban_persen, kelembaban_status, 0, "TIDAK SIRAM", 0)
    else:
        print("[FUZZY] Bukan waktu penyiraman.")
        durasi = 0

    return {
        "ph": ph,
        "ph_status": ph_status,
        "kelembaban_adc": kelembaban_adc,
        "kelembaban_persen": kelembaban_persen,
        "kelembaban_status": kelembaban_status,
        "durasi": durasi
    }
